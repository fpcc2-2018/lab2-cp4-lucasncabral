---
title: 'Lab 2, CP 4: AnÃ¡lise completa'
output:
  html_document:
    df_print: paged
---

```{r setup}
library(tidyverse)
library(here)
library(lubridate)
theme_set(theme_bw())
```

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv"))
```


## Manipulação dos dados 

```{r}

buscas %>% 
    group_by(group) %>% 
    summarise(n = n()) %>% 
    ggplot(aes(x = group, y = n, fill = group, color = group)) +
    theme(legend.position="none") +
    geom_col()

buscas %>% 
    mutate(date = floor_date(session_start_date, unit = "day")) %>% 
    count(date, group) %>%
    ggplot(aes(x = date, y = n, fill = "red")) +
    xlab("Data") +
    ylab("Contagem") +
    theme(legend.position="none") +
    geom_col()

buscas %>% 
    ggplot(aes(x = "Total de resultados", y = results)) + 
    geom_boxplot(outlier.shape=NA) +
    scale_y_log10()

buscas %>% 
    ggplot(aes(x = "Posição da página", y = click_position)) + 
    geom_boxplot(outlier.shape=NA) +
    scale_y_log10()

buscas %>% 
    ggplot(aes(x = "Resultados", y = results)) + 
    geom_boxplot(outlier.shape=NA) +
    scale_y_log10()
```

# Pergunta 1
### What is our daily overall clickthrough rate? How does it vary between the groups?
Para respondermos essa pergunta, utilizaremos duas variaveis do nosso conjunto de dados, são elas: group e session_start_date. Para observamos os dados utilizaremos dois gráficos de linha que representam a quantidade de sessões no total e por grupos:
```{r}
buscas %>%
    mutate(date = floor_date(session_start_date, unit = "day")) %>% 
    count(date) %>%
    ggplot(aes(x = date, y = n)) +
    xlab("Data") +
    ylab("Contagem") +
    geom_line()+ 
    geom_point()

buscas %>%
    mutate(date = floor_date(session_start_date, unit = "day")) %>% 
    count(date, group) %>%
    ggplot(aes(x = date, y = n, fill = group, color = group)) +
    xlab("Data") +
    ylab("Contagem") +
    geom_line()+ 
    geom_point()

min(buscas$session_start_date)
max(buscas$session_start_date)
```

As visualizações nos permite perceber que durante os nove dias de dados coletados, a quantidade do grupo A foi superior ao do grupo B. Além disso, podemos observar que os dois grupos apresentam comportamentos semelhantes durante os dias, apesar de que, podemos observar que no ultimo dia os dados foram coletados apenas até as 20 horas, comprometendo assim a comparação nesse dia.

Além disso, podemos perceber através do gráfico de dispersão abaixo uma grande presença de sessões com 0 ou 1 cliques, concentrando grande parte dos pontos na parte inferior do gráfico.

```{r}
buscas %>% 
    ggplot(aes(x = group, y = num_clicks)) + 
    geom_jitter(aes(alpha = .4, width = .2, size = .8, color = group)) +
    scale_y_log10() +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none")
```



# Pergunta 2
### Which results do people tend to try first?

Para responder essa pergunta utilizaremos a variavel click_position, onde podemos observar que tanto para a moda como para a mediana os valores se concentram em 1.

```{r}
summary(buscas$click_position)

buscas %>% 
    ggplot(aes(x = click_position)) + 
    scale_x_log10() +
    stat_ecdf()

statmod <- function(x) { 
z <- table(as.vector(x)) 
names(z)[z == max(z)] 
} 

statmod(buscas$click_position)
```

### How does it change day-to-day?
Podemos observar através dessa visualização que não a variação durante os dias para essa variavel.

```{r}
buscas %>%
    mutate(date = floor_date(session_start_date, unit = "day")) %>%
    mutate(moda = statmod(click_position)) %>%
    count(date, moda) %>%
    ggplot(aes(x = date, y = moda)) +
    xlab("Data") +
    ylab("Moda") +
    geom_line() + 
    geom_point()
```


#Pergunta 3
### What is our daily overall zero results rate? How does it vary between the groups?
Em relação a taxa de resultados zero podemos observar uma presença significativa nos dados, conforme o gráfico que compara a porcentagem de sessões por dia que retornaram 0 resultados entre todos os dados.

```{r}

buscas %>% 
    mutate(date = floor_date(session_start_date, unit = "day")) %>% 
    mutate(resultCount = ifelse(buscas$results > 0, "Um ou mais resultados", "Zero resultados")) %>%
    count(date, resultCount) %>%
    ggplot(aes(x = date, y = n, fill = resultCount)) +
    xlab("Data") +
    ylab("Contagem") +
    geom_col() +
    geom_text(aes(label=sprintf("%0.2f%%",(n/nrow(buscas)) * 100)), position=position_dodge(width=0.5), vjust=-0.25) 

buscas %>% 
    mutate(date = floor_date(session_start_date, unit = "day")) %>% 
    mutate(resultCount = ifelse(buscas$results > 0, "Um ou mais resultados", "Zero resultados")) %>%
    count(date, resultCount, group) %>%
    ggplot(aes(x = date, y = n, fill = resultCount)) +
    xlab("Data") +
    facet_grid(~group) +
    ylab("Contagem") +
    geom_col()+
    geom_text(aes(label=sprintf("%0.2f%%",(n/nrow(buscas)) * 100)), position=position_dodge(width=0.2), vjust=-0.25) 

```


#Pergunta 4
### Let session length be approximately the time between the first event and the last event in a session. Choose a variable from the dataset and describe its relationship to session length. Visualize the relationship.
Comparamos o tempo da sessão em cada grupo, e podemos observar que em média o grupo A possui sessões maiores que o grupo B, porem o grupo B possui 75% de seus dados com tempo abaixo de 0.0

```{r}

buscas %>% 
    mutate(lenght = buscas$session_finish_timestamp - buscas$session_start_timestamp) %>% 
    ggplot(aes(x = "Tempo", y = lenght)) + 
    geom_boxplot(outlier.shape=NA) +
    scale_y_log10()

buscas %>%
    mutate(lenght = buscas$session_finish_timestamp - buscas$session_start_timestamp) %>% 
    ggplot(aes(x = group, y = lenght, color = group)) + 
    scale_y_log10() +
    geom_jitter(alpha = .3)

summary(filter(mutate(buscas,lenght = buscas$session_finish_timestamp - buscas$session_start_timestamp), group== "a")$lenght)
summary(filter(mutate(buscas,lenght = buscas$session_finish_timestamp - buscas$session_start_timestamp), group== "b")$lenght)
```